<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snake TV Party</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #1a1a1a; color: white; font-family: 'Courier New', monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        
        /* SCREENS */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        /* HOST SCREEN (iPad) */
        #qr-container { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        h1 { margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 2px; }
        p { color: #aaa; text-align: center; max-width: 80%; }
        
        canvas { background: #000; border: 4px solid #444; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: none; }
        #score-board { font-size: 24px; margin-bottom: 10px; display: none; }

        /* REMOTE SCREEN (Mobile) */
        #remote-ui { width: 100%; height: 100%; display: grid; grid-template-rows: 1fr 2fr; gap: 10px; padding: 20px; box-sizing: border-box; }
        .d-pad { display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 300px; margin: auto; aspect-ratio: 1/1; }
        .btn { background: #333; border-radius: 15px; border: 2px solid #555; display: flex; align-items: center; justify-content: center; font-size: 30px; user-select: none; touch-action: manipulation; }
        .btn:active { background: #00ff00; border-color: #00ff00; color: #000; }
        .btn-up { grid-column: 2; grid-row: 1; }
        .btn-left { grid-column: 1; grid-row: 2; }
        .btn-right { grid-column: 3; grid-row: 2; }
        .btn-down { grid-column: 2; grid-row: 3; }
        
        #connection-status { position: absolute; top: 10px; left: 10px; font-size: 12px; color: yellow; }
    </style>
</head>
<body>

    <div id="connection-status">Initializing...</div>

    <div id="host-screen" class="screen">
        <h1>Snake Party</h1>
        <div id="setup-panel">
            <div id="qr-container">
                <div id="qrcode"></div>
            </div>
            <p>Scan this with your mobile to connect instantly!</p>
            <p style="font-size: 12px; margin-top: 10px;">Waiting for player...</p>
        </div>

        <div id="score-board">Score: <span id="score">0</span></div>
        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <div id="remote-screen" class="screen">
        <h2 style="text-align: center;">Controller</h2>
        <div id="remote-ui">
            <div style="display: flex; justify-content: center; align-items: center; color: #888;">
                SWIPE or TAP
            </div>
            <div class="d-pad">
                <div class="btn btn-up" ontouchstart="send('up')" onmousedown="send('up')">⬆️</div>
                <div class="btn btn-left" ontouchstart="send('left')" onmousedown="send('left')">⬅️</div>
                <div class="btn btn-right" ontouchstart="send('right')" onmousedown="send('right')">➡️</div>
                <div class="btn btn-down" ontouchstart="send('down')" onmousedown="send('down')">⬇️</div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const isRemote = new URLSearchParams(window.location.search).has('hostId');
        let peer, conn;
        
        // DOM Elements
        const statusEl = document.getElementById('connection-status');
        const hostScreen = document.getElementById('host-screen');
        const remoteScreen = document.getElementById('remote-screen');

        // --- INIT LOGIC ---
        if (isRemote) {
            initRemote();
        } else {
            initHost();
        }

        // ================= HOST CODE (iPad/TV) =================
        function initHost() {
            hostScreen.classList.add('active');
            peer = new Peer(); // Auto-generate ID

            peer.on('open', (id) => {
                statusEl.innerText = "Host Ready. ID: " + id;
                
                // Generate QR Code with current URL + ID
                const currentUrl = window.location.href.split('?')[0];
                const joinLink = `${currentUrl}?hostId=${id}`;
                
                new QRCode(document.getElementById("qrcode"), {
                    text: joinLink,
                    width: 200,
                    height: 200
                });
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
            });
        }

        function setupConnection() {
            // Hide QR, Show Game
            document.getElementById('setup-panel').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('score-board').style.display = 'block';
            statusEl.innerText = "Player Connected!";
            statusEl.style.color = "#00ff00";

            startGame();

            conn.on('data', (data) => {
                handleInput(data);
            });

            conn.on('close', () => {
                alert("Player disconnected!");
                location.reload();
            });
        }

        // ================= SNAKE GAME ENGINE =================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const box = 20;
        let snake = [{x: 10 * box, y: 10 * box}];
        let food = {x: 0, y: 0};
        let d = ""; 
        let score = 0;
        let gameLoop;

        function startGame() {
            placeFood();
            document.addEventListener('keydown', kbControl); // Allow keyboard too
            gameLoop = setInterval(draw, 100);
        }

        function placeFood() {
            food = {
                x: Math.floor(Math.random() * (canvas.width/box)) * box,
                y: Math.floor(Math.random() * (canvas.height/box)) * box
            }
        }

        function handleInput(dir) {
            if(dir === 'left' && d !== 'RIGHT') d = 'LEFT';
            if(dir === 'up' && d !== 'DOWN') d = 'UP';
            if(dir === 'right' && d !== 'LEFT') d = 'RIGHT';
            if(dir === 'down' && d !== 'UP') d = 'DOWN';
        }

        // Keyboard fallback for testing on PC
        function kbControl(event) {
            if(event.keyCode == 37) handleInput('left');
            if(event.keyCode == 38) handleInput('up');
            if(event.keyCode == 39) handleInput('right');
            if(event.keyCode == 40) handleInput('down');
        }

        function draw() {
            // Background
            ctx.fillStyle = "#222";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Snake
            for(let i = 0; i < snake.length; i++) {
                ctx.fillStyle = (i === 0) ? "#00ff00" : "#009900";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
                ctx.strokeStyle = "#000";
                ctx.strokeRect(snake[i].x, snake[i].y, box, box);
            }

            // Food
            ctx.fillStyle = "red";
            ctx.fillRect(food.x, food.y, box, box);

            // Logic
            let snakeX = snake[0].x;
            let snakeY = snake[0].y;

            if(d === 'LEFT') snakeX -= box;
            if(d === 'UP') snakeY -= box;
            if(d === 'RIGHT') snakeX += box;
            if(d === 'DOWN') snakeY += box;

            // Eat Food
            if(snakeX === food.x && snakeY === food.y) {
                score++;
                document.getElementById('score').innerText = score;
                placeFood();
                // Send feedback to phone
                if(conn) conn.send('vibrate');
            } else {
                // Remove tail
                snake.pop();
            }

            // Game Over Rules
            let newHead = {x: snakeX, y: snakeY};
            
            if(snakeX < 0 || snakeX >= canvas.width || snakeY < 0 || snakeY >= canvas.height || collision(newHead, snake)) {
                clearInterval(gameLoop);
                if(conn) conn.send('dead');
                alert("Game Over! Score: " + score);
                location.reload();
            }

            if(d !== "") snake.unshift(newHead);
        }

        function collision(head, array) {
            for(let i = 0; i < array.length; i++) {
                if(head.x === array[i].x && head.y === array[i].y) return true;
            }
            return false;
        }


        // ================= REMOTE CODE (Mobile) =================
        function initRemote() {
            remoteScreen.classList.add('active');
            const urlParams = new URLSearchParams(window.location.search);
            const hostId = urlParams.get('hostId');

            statusEl.innerText = "Connecting to Host...";
            
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(hostId);

                conn.on('open', () => {
                    statusEl.innerText = "CONNECTED!";
                    statusEl.style.color = "#00ff00";
                    document.body.style.background = "#111"; // Visual feedback
                });

                conn.on('data', (data) => {
                    if(data === 'vibrate' && navigator.vibrate) navigator.vibrate(50);
                    if(data === 'dead' && navigator.vibrate) navigator.vibrate([200, 100, 200]);
                });
            });
        }

        function send(command) {
            if(conn && conn.open) {
                conn.send(command);
                if(navigator.vibrate) navigator.vibrate(10); // Haptic feedback
            }
        }
    </script>
</body>
</html>
